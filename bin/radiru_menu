#!/usr/bin/env ruby
=begin
らじる★らじるの聴き逃しにある番組ページURIから、指定したワードを含むタイトルを抜き出し、URIを調べる。
=end

require "selenium-webdriver"
require "optparse"
require "pp"

uri = "https://www.nhk.or.jp/radio/ondemand/detail.html?p=5832_01"

def ondemand_url(str, driver)
  elements = driver.find_elements(:css, 'div.progblock li a')
  matches = elements.find_all { |el| el.text =~ /#{str}/ }
  return if matches.empty?
  mh = driver.window_handle

  matches.map do |el|
    driver.switch_to.window mh if driver.window_handle != mh
    h3 = el.find_element :css, 'h3.title'
    element_title = h3.text
    p element_title
    el.click
    wait = Selenium::WebDriver::Wait.new(timeout: 3)
    sleep 1

    handle = driver.window_handles.find {|wh|
      driver.switch_to.window wh
      driver.title =~ /プレーヤー/
    }
    if handle
      player = driver.find_element(:css, 'div.nol_audio_player')
      data_aa = player.attribute('data-aa')
      type, title, station, s, stoe = data_aa.split(';')
      starttime, endtime = stoe.split('_')
      {
        text: element_title,
        title: title,
        station: station,
        start_time: starttime,
        end_time: endtime,
        url: player.attribute('data-hlsurl'),
        aa: data_aa,
      }
    end
  end
end


begin
  driver = Selenium::WebDriver.for :safari
  driver.navigate.to uri
  wait = Selenium::WebDriver::Wait.new(timeout: 3)
  pp ondemand_url(ARGV[0], driver)

ensure
  driver.quit
end