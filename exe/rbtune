#!/usr/bin/env ruby
# coding: utf-8
# 日本のラジオ局のサイトから再生（または録音）する

require "rbtune"
require "keychain"
require "optparse"
require "pp"

filename = nil
min      = 30
quiet    = false
wait     = 0

account         = nil
prefecture      = nil
$set_prefecture = false

stations = Radio.bands.map { |radio|
  begin
    chs = radio::channels
    chs && chs.keys
  rescue PStore::Error
    $stderr.puts "WARNING! ラジコの放送局情報が登録されていません。rbtune --fetch-prefecture または rbtune --set-prefecture (県名) を実行してください"
    []
  end
}.flatten!


opt = OptionParser.new
Version = Rbtune::VERSION
opt.banner += <<EOS
 station min

    station: #{stations*'|'}

    min:     minutes

 らじる★らじる、ラジコなどの日本のラジオ局のサイトから再生（または録音）する

EOS
opt.on("-o ファイル名","--output","録音するファイル名"){|v| filename = v}
opt.on("-m [30]", "--min", Float, "録音時間 (分）"){|v| min = v}
opt.on("-w [0]", "--wait", Float, "録音開始までの待ち時間（秒）")
opt.on("-q", "--quiet", "録音時に再生しない" ) {|v| quiet = true}
opt.on("--set-account ACCOUNT", "ラジコプレミアムのアカウントを登録して終了") {|v| account = v}
opt.on("--set-prefecture [PREFECTURE]", "ラジコの県域情報を設定して終了") {|v|
  $set_prefecture = true
  prefecture = v
}
opt.on("--fetch-prefecture", "ラジコの県域情報を取得して終了") {
  $set_prefecture = true
}
opt.on("--show-prefecture", "ラジコの県域情報を表示して終了") {
  $show_prefecture = true
}
opt.parse! ARGV

kc = KeyChain.new("http://radiko.jp")
case
when account
  RadikoPremium.set_authentication kc, account
  exit

when $set_prefecture
  begin
    RadikoPrefecture.prefecture = prefecture
    puts "#{prefecture} #{RadikoPrefecture.prefecture} を登録しました"
    exit
  rescue RuntimeError
    $stderr.puts $!
    exit 1
  end

when $show_prefecture
  puts RadikoPrefecture.prefecture
  exit
end

unless ARGV.size == 1
  puts opt.help
  exit 1
end
channel = ARGV[0].upcase

radio_class = Radio.find channel
unless radio_class
  radio_class, station = Radio.match channel
  if radio_class
    puts "station: #{station.name}"
    channel = station.id
  else
    puts "放送局コード #{channel} は登録されていません"
    exit 1
  end
end
radio = radio_class.new
radio.outdir = ENV['RADIODIR'] || '.'

begin
  if radio.is_a? RadikoPremium
    account, password = kc.account
    radio.login account, password
  end
  radio.open
  p "area: #{radio.area_id} (#{radio.area_ja}: #{radio.area_en})"
  radio.tune channel
  if filename
    sec = min*60
    radio.record filename, sec, wait: wait, quiet: quiet
  else
    radio.play
  end

rescue Radio::HTTPForbiddenException
  puts 'ラジコプレミアムの認証に失敗しました。--set-account オプションで正しいアカウントとパスワードを設定してください'

rescue Interrupt
  # do nothing

ensure
  radio.close
end
